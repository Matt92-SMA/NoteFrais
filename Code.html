<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner Code Barre</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f5f5f5;
}
#reader {
    width: 300px;
    margin: 20px auto;
}
button {
    padding: 10px 15px;
    margin: 5px;
    border: none;
    background: #0d6efd;
    color: white;
    border-radius: 5px;
    cursor: pointer;
}
button:hover {
    opacity: 0.8;
}
table {
    width: 90%;
    margin: 20px auto;
    border-collapse: collapse;
    background: white;
}
th, td {
    border: 1px solid #ddd;
    padding: 8px;
}
th {
    background: #0d6efd;
    color: white;
}
</style>
</head>

<body>

<h2>Lecteur de Code Barre</h2>

<div id="reader"></div>

<button onclick="exportCSV()">Exporter en CSV</button>
<button onclick="clearData()">Vider les donn√©es</button>
<button onclick="switchCamera()">Changer de cam√©ra</button>

<table>
<thead>
<tr>
<th>Code Barre</th>
<th>Date / Heure</th>
</tr>
</thead>
<tbody id="dataTable"></tbody>
</table>

<script>

// ===============================
// VARIABLES GLOBALES
// ===============================

let scans = JSON.parse(localStorage.getItem("barcode_scans")) || [];
let html5QrCode = new Html5Qrcode("reader");
let cameras = [];
let currentCameraIndex = 0;
let scannerRunning = false;

const tableBody = document.getElementById("dataTable");

// ===============================
// AFFICHAGE TABLE
// ===============================

function renderTable() {
    tableBody.innerHTML = "";

    scans.forEach(scan => {
        const tr = document.createElement("tr");

        const tdCode = document.createElement("td");
        tdCode.textContent = scan.code;

        const tdDate = document.createElement("td");
        tdDate.textContent = scan.date;

        tr.appendChild(tdCode);
        tr.appendChild(tdDate);

        tableBody.appendChild(tr);
    });
}

renderTable();

// ===============================
// MESSAGE VISUEL
// ===============================

const messageDiv = document.createElement("div");
messageDiv.style.fontSize = "20px";
messageDiv.style.fontWeight = "bold";
messageDiv.style.color = "green";
messageDiv.style.marginTop = "10px";

document.body.insertBefore(messageDiv, document.querySelector("table"));

// ===============================
// SCAN SUCCESS
// ===============================

function onScanSuccess(decodedText) {

    // √âviter doublon imm√©diat
    if (scans.length > 0 && scans[scans.length - 1].code === decodedText) {
        return;
    }

    const now = new Date();
    const formattedDate = now.toLocaleString();

    const scanData = {
        code: decodedText,
        date: formattedDate
    };

    scans.push(scanData);
    localStorage.setItem("barcode_scans", JSON.stringify(scans));

    renderTable();

    // Vibration mobile
    if (navigator.vibrate) {
        navigator.vibrate(200);
    }

    messageDiv.innerText = "‚úÖ Passer √† l'article suivant";

    setTimeout(() => {
        messageDiv.innerText = "";
    }, 2000);
}

// ===============================
// D√âMARRAGE SCANNER
// ===============================

function startScanner(cameraConfig) {

    html5QrCode.start(
        cameraConfig,
        {
            fps: 10,
            qrbox: 250
        },
        onScanSuccess
    ).then(() => {
        scannerRunning = true;
    }).catch(err => {
        console.error("Erreur d√©marrage cam√©ra :", err);
    });
}

// Charger cam√©ras
Html5Qrcode.getCameras().then(devices => {

    if (!devices || devices.length === 0) {
        alert("Aucune cam√©ra d√©tect√©e");
        return;
    }

    cameras = devices;

    // üî• D√©marrage fiable en cam√©ra arri√®re
    startScanner({ facingMode: "environment" });

}).catch(err => {
    console.error("Erreur acc√®s cam√©ras :", err);
});

// ===============================
// CHANGER CAM√âRA
// ===============================

function switchCamera() {

    if (!cameras.length) return;

    html5QrCode.stop().then(() => {

        currentCameraIndex++;

        if (currentCameraIndex >= cameras.length) {
            currentCameraIndex = 0;
        }

        startScanner(cameras[currentCameraIndex].id);

        messageDiv.innerText = "üì∑ Cam√©ra chang√©e";
        setTimeout(() => messageDiv.innerText = "", 2000);

    }).catch(err => {
        console.error("Erreur changement cam√©ra :", err);
    });
}

// ===============================
// EXPORT CSV
// ===============================

function exportCSV() {

    if (scans.length === 0) {
        alert("Aucune donn√©e √† exporter.");
        return;
    }

    let csvContent = "Code Barre,Date Heure\n";

    scans.forEach(scan => {
        csvContent += `"${scan.code}","${scan.date}"\n`;
    });

    const blob = new Blob([csvContent], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "scans_code_barre.csv";
    a.click();

    URL.revokeObjectURL(url);
}

// ===============================
// VIDER DONN√âES
// ===============================

function clearData() {

    if (confirm("Supprimer toutes les donn√©es ?")) {

        localStorage.removeItem("barcode_scans");
        scans = [];
        renderTable();
    }
}

</script>

</body>
</html>
