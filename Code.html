<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner Code Barre</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f5f5f5;
}
#reader {
    width: 300px;
    margin: 20px auto;
}
button {
    padding: 10px 15px;
    margin: 5px;
    border: none;
    background: #0d6efd;
    color: white;
    border-radius: 5px;
    cursor: pointer;
}
button:hover {
    opacity: 0.8;
}
table {
    width: 90%;
    margin: 20px auto;
    border-collapse: collapse;
    background: white;
}
th, td {
    border: 1px solid #ddd;
    padding: 8px;
}
th {
    background: #0d6efd;
    color: white;
}
</style>

</head>
<body>

<h2>Lecteur de Code Barre</h2>

<div id="reader"></div>

<button onclick="exportCSV()">Exporter en CSV</button>
<button onclick="clearData()">Vider les donn√©es</button>
<button onclick="switchCamera()">Changer de cam√©ra</button>

<table>
    <thead>
        <tr>
            <th>Code Barre</th>
            <th>Date / Heure</th>
        </tr>
    </thead>
    <tbody id="dataTable"></tbody>
</table>

<script>

// Charger donn√©es existantes
let scans = JSON.parse(localStorage.getItem("barcode_scans")) || [];
const tableBody = document.getElementById("dataTable");

function renderTable() {
    tableBody.innerHTML = "";
    scans.forEach(scan => {
        let row = `<tr>
            <td>${scan.code}</td>
            <td>${scan.date}</td>
        </tr>`;
        tableBody.innerHTML += row;
    });
}

renderTable();

// Message visuel
const messageDiv = document.createElement("div");
messageDiv.style.fontSize = "20px";
messageDiv.style.fontWeight = "bold";
messageDiv.style.color = "green";
messageDiv.style.marginTop = "10px";
document.body.insertBefore(messageDiv, document.querySelector("table"));

function onScanSuccess(decodedText) {

    // √âviter doublons imm√©diats
    if (scans.length > 0 && scans[scans.length - 1].code === decodedText) {
        return;
    }

    const now = new Date();
    const formattedDate = now.toLocaleString();

    const scanData = {
        code: decodedText,
        date: formattedDate
    };

    scans.push(scanData);
    localStorage.setItem("barcode_scans", JSON.stringify(scans));

    renderTable();

    // ‚úÖ Afficher message
    messageDiv.innerText = "‚úÖ Passer √† l'article suivant";

    // Effacer message apr√®s 2 secondes
    setTimeout(() => {
        messageDiv.innerText = "";
    }, 2000);
}

function startScanner(cameraId) {
    html5QrCode.start(
        cameraId,
        {
            fps: 10,
            qrbox: 250
        },
        onScanSuccess
    ).then(() => {
        scannerRunning = true;
    }).catch(err => {
        console.error("Erreur d√©marrage cam√©ra :", err);
    });
}

// Charger cam√©ras disponibles
Html5Qrcode.getCameras().then(devices => {
    if (devices && devices.length) {
        cameras = devices;

        // Par d√©faut on prend la cam√©ra arri√®re si possible
        let backIndex = devices.findIndex(device =>
            device.label.toLowerCase().includes("back") ||
            device.label.toLowerCase().includes("rear") ||
            device.label.toLowerCase().includes("environment")
        );

        currentCameraIndex = backIndex !== -1 ? backIndex : 0;

        startScanner(cameras[currentCameraIndex].id);
    }
}).catch(err => {
    console.error("Erreur acc√®s cam√©ras :", err);
});

// Export CSV
function exportCSV() {
    if (scans.length === 0) {
        alert("Aucune donn√©e √† exporter.");
        return;
    }

    let csvContent = "Code Barre,Date Heure\n";

    scans.forEach(scan => {
        csvContent += `"${scan.code}","${scan.date}"\n`;
    });

    const blob = new Blob([csvContent], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "scans_code_barre.csv";
    a.click();

    URL.revokeObjectURL(url);
}

// Vider donn√©es
function clearData() {
    if (confirm("Supprimer toutes les donn√©es ?")) {
        localStorage.removeItem("barcode_scans");
        scans = [];
        renderTable();
    }
}
function switchCamera() {

    if (!cameras.length) return;

    html5QrCode.stop().then(() => {

        // Passer √† la cam√©ra suivante
        currentCameraIndex++;
        if (currentCameraIndex >= cameras.length) {
            currentCameraIndex = 0;
        }

        startScanner(cameras[currentCameraIndex].id);

        messageDiv.innerText = "üì∑ Cam√©ra chang√©e";
        setTimeout(() => messageDiv.innerText = "", 2000);

    }).catch(err => {
        console.error("Erreur changement cam√©ra :", err);
    });
}

</script>

</body>
</html>


