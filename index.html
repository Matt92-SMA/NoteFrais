<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Note de frais</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: sans-serif;
      background-color: #fff8f0;
      color: #fd7702;
      padding: 20px;
    }

    h2, h3 {
      color: #d35400;
    }

    label {
      display: block;
      margin-top: 10px;
    }

    input, select {
      padding: 5px;
      border: 1px solid #e67e22;
      border-radius: 4px;
      width: 100%;
      max-width: 300px;
    }

    button {
      margin-top: 10px;
      background-color: #e67e22;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
    }

    button:hover {
      background-color: #cf711a;
    }

    table {
      margin-top: 20px;
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
    }

    th, td {
      border: 1px solid #e67e22;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f39c12;
      color: white;
    }

    .hidden {
      display: none;
    }

    #sidebar {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 250px;
      background-color: #fdf2e9;
      border: 1px solid #e67e22;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
    }

    #historiqueNDF {
      list-style: none;
      padding-left: 0;
    }

    #historiqueNDF li {
      margin-bottom: 5px;
      font-size: 0.9em;
      cursor: pointer;
      text-decoration: underline;
    }

    .header-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 40px;
      margin-bottom: 20px;
    }

    .header-col {
      flex: 1 1 300px;
    }

    /* Responsive Mobile */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      input, select, button {
        max-width: 100%;
        font-size: 1em;
        padding: 8px;
      }

      .header-grid {
        flex-direction: column;
        gap: 10px;
      }

      .header-col {
        flex: 1 1 100%;
      }

      table th, table td {
        font-size: 0.85em;
        padding: 6px;
      }

      h2, h3 {
        font-size: 1.3em;
      }

      button {
        width: 100%;
      }

      #sidebar {
        position: static;
        width: 100%;
        margin-top: 20px;
      }
    }
  </style>

  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script defer src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
</head>
<body>
  <h2>Note de frais - SOFT MEDICAL AESTHETICS</h2>

  <div id="header-section" class="header-grid">
    <div class="header-col">
      <label>Nom : <input type="text" id="nom" required></label>
      <label>Pr√©nom : <input type="text" id="prenom" required></label>
      <label>Responsable : <input type="text" id="responsable" required></label>
    </div>
    <div class="header-col">
      <label>Service :
        <select id="service" required>
          <option value="">-- S√©lectionner --</option>
          <option>ADV</option>
          <option>ADMIN</option>
          <option>COMM</option>
          <option>QUALITE</option>
          <option>R&D</option>
          <option>REGLEMENTAIRE</option>
          <option>SALES</option>
        </select>
      </label>
      <label>Mois : <input type="month" id="mois" required></label>
    </div>
  </div>

  <a href="historique.html"><button>üìÅ Voir mes anciennes NDF</button></a>
  <button onclick="toggleLigneForm()">‚ûï Ajouter une ligne de frais</button>

  <form id="fraisForm" class="hidden">
    <h3>Nouvelle ligne de frais</h3>
    <label>Date : <input type="date" id="date" required></label>
    <label>Type :
      <select id="type">
        <option>Repas</option>
        <option>Transport</option>
        <option>H√¥tel</option>
        <option>Indemnit√©s Kilom√©triques</option>
        <option>P√©ages & Parking</option>
        <option>Achat de Mat√©riel</option>
        <option>Poste</option>
        <option>Autre</option>
      </select>
    </label>
    <label>Montant TTC (‚Ç¨) : <input type="number" id="ttc" step="0.01" required></label>
    <label>TVA :
      <select id="tva">
        <option value="0.20">20%</option>
        <option value="0.10">10%</option>
        <option value="0.055">5.5%</option>
        <option value="0">0%</option>
      </select>
    </label>
    <label>Description : <input type="text" id="description"></label>
    <label>Justificatif : <input type="file" id="justificatif" accept="image/*,.pdf" capture="environment" required></label>
    <button type="submit">Ajouter la ligne</button>
  </form>

  <h3>Tableau r√©capitulatif</h3>
  <div id="pdf-content">
    <p id="identite"></p>
    <table id="tableFrais">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>HT (‚Ç¨)</th>
          <th>TVA (‚Ç¨)</th>
          <th>TTC (‚Ç¨)</th>
          <th>Description</th>
          <th>Justificatif</th>
          <th>Supprimer</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th colspan="2">Total</th>
          <th id="totalHT">0.00</th>
          <th id="totalTVA">0.00</th>
          <th id="totalTTC">0.00</th>
          <th colspan="3"></th>
        </tr>
      </tfoot>
    </table>
  </div>

  <button onclick="generatePDF()">üìÑ Exporter en PDF</button>
  <button onclick="ouvrirOutlook()">‚úâÔ∏è Envoyer par Outlook</button>

  <script>
    const form = document.getElementById('fraisForm');
    const tbody = document.querySelector('#tableFrais tbody');
    const identite = document.getElementById('identite');
    const justificatifs = [];

    function toggleLigneForm() {
      form.classList.toggle('hidden');
      if (!form.classList.contains('hidden')) {
        form.scrollIntoView({ behavior: 'smooth' });
      }
    }

    function mettreAJourTotal() {
      let totalHT = 0, totalTVA = 0, totalTTC = 0;
      tbody.querySelectorAll('tr').forEach(tr => {
        totalHT += parseFloat(tr.children[2].innerText) || 0;
        totalTVA += parseFloat(tr.children[3].innerText) || 0;
        totalTTC += parseFloat(tr.children[4].innerText) || 0;
      });
      document.getElementById('totalHT').innerText = totalHT.toFixed(2);
      document.getElementById('totalTVA').innerText = totalTVA.toFixed(2);
      document.getElementById('totalTTC').innerText = totalTTC.toFixed(2);
    }

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const date = document.getElementById('date').value;
      const type = document.getElementById('type').value;
      const ttc = parseFloat(document.getElementById('ttc').value);
      const tauxTVA = parseFloat(document.getElementById('tva').value);
      const description = document.getElementById('description').value;
      const fichier = document.getElementById('justificatif').files[0];
      const ht = (ttc / (1 + tauxTVA)).toFixed(2);
      const tva = (ttc - ht).toFixed(2);

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${date}</td>
        <td>${type}</td>
        <td>${ht}</td>
        <td>${tva}</td>
        <td>${ttc.toFixed(2)}</td>
        <td>${description}</td>
        <td>${fichier.name}</td>
        <td><button onclick="this.closest('tr').remove(); mettreAJourTotal();">‚ùå</button></td>
      `;
      tbody.appendChild(row);
      mettreAJourTotal();

      const reader = new FileReader();
      reader.onload = () => justificatifs.push({ name: fichier.name, data: reader.result });
      reader.readAsArrayBuffer(fichier);

      form.reset();
      form.classList.add('hidden');

      const nom = document.getElementById('nom').value;
      const prenom = document.getElementById('prenom').value;
      const service = document.getElementById('service').value;
      const mois = document.getElementById('mois').value;
      if (nom && prenom && service && mois) {
        identite.innerText = `Nom : ${nom} ${prenom} ‚Äî Service : ${service} ‚Äî Mois : ${mois}`;
      }
    });

    function genererIDUnique(mois) {
      const [annee, moisNum] = mois.split("-");
      const prefixe = annee.slice(2) + moisNum;
      const compteurCle = "compteur_" + prefixe;
      let compteur = parseInt(localStorage.getItem(compteurCle) || "0", 10);
      compteur++;
      localStorage.setItem(compteurCle, compteur);
      return `${prefixe}-${compteur.toString().padStart(4, "0")}`;
    }

    async function generatePDF() {
      if (!confirm("Souhaitez-vous vraiment exporter cette note de frais en PDF ?")) return;
      const nom = document.getElementById('nom').value.trim();
      const prenom = document.getElementById('prenom').value.trim();
      const service = document.getElementById('service').value.trim();
      const mois = document.getElementById('mois').value;
      if (!nom || !prenom || !service || !mois) {
        alert("Merci de remplir Nom, Pr√©nom, Service et Mois.");
        return;
      }

      const idNDF = genererIDUnique(mois);
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(12);
      doc.text(`Note de frais`, 10, 10);
      doc.text(`ID Note de frais : ${idNDF}`, 10, 20);
      doc.text(`Nom : ${nom} ${prenom}`, 10, 30);
      doc.text(`Service : ${service}`, 10, 37);
      doc.text(`P√©riode : ${mois}`, 10, 44);

      const rows = Array.from(tbody.querySelectorAll('tr')).map(tr => [
        tr.children[0].innerText,
        tr.children[1].innerText,
        tr.children[2].innerText,
        tr.children[3].innerText,
        tr.children[4].innerText,
        tr.children[5].innerText
      ]);
      rows.push(["", "TOTAL", document.getElementById('totalHT').innerText, document.getElementById('totalTVA').innerText, document.getElementById('totalTTC').innerText, ""]);

      doc.autoTable({ head: [['Date', 'Type', 'HT (‚Ç¨)', 'TVA (‚Ç¨)', 'TTC (‚Ç¨)', 'Description']], body: rows, startY: 50 });

      const mainPdfBytes = doc.output('arraybuffer');
      const pdfDoc = await PDFLib.PDFDocument.create();
      const mainDoc = await PDFLib.PDFDocument.load(mainPdfBytes);
      const copiedPages = await pdfDoc.copyPages(mainDoc, mainDoc.getPageIndices());
      copiedPages.forEach(p => pdfDoc.addPage(p));

      for (const file of justificatifs) {
        const ext = file.name.split('.').pop().toLowerCase();
        try {
          if (ext === 'pdf') {
            const jf = await PDFLib.PDFDocument.load(file.data);
            const pages = await pdfDoc.copyPages(jf, jf.getPageIndices());
            pages.forEach(p => pdfDoc.addPage(p));
          } else {
            const img = await pdfDoc.embedJpg(file.data).catch(() => pdfDoc.embedPng(file.data));
            const page = pdfDoc.addPage([img.width, img.height]);
            page.drawImage(img, { x: 0, y: 0, width: img.width, height: img.height });
          }
        } catch (e) {
          alert(`Erreur avec le fichier : ${file.name}`);
        }
      }

      const finalPdfBytes = await pdfDoc.save();
      const blob = new Blob([finalPdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `NDF_${idNDF}_${nom}_${prenom}.pdf`;
      link.click();

      const histo = JSON.parse(localStorage.getItem("historiqueNDF") || "[]");
      histo.unshift({ id: idNDF, nom, prenom, mois, fichier: link.download, dateExport: new Date().toISOString() });
      localStorage.setItem("historiqueNDF", JSON.stringify(histo));
    }

    function ouvrirOutlook() {
      const nom = document.getElementById('nom').value.trim();
      const prenom = document.getElementById('prenom').value.trim();
      const mois = document.getElementById('mois').value;
      if (!nom || !prenom || !mois) {
        alert("Merci de remplir Nom, Pr√©nom et Mois avant d‚Äôenvoyer.");
        return;
      }
      const sujet = encodeURIComponent(`Note de frais - ${prenom} ${nom} - ${mois}`);
      const corps = encodeURIComponent("Bonjour,\n\nVeuillez trouver ci-joint ma note de frais.\n\nCordialement,\n\n" + prenom + " " + nom);
      window.location.href = `mailto:?subject=${sujet}&body=${corps}`;
    }
  </script>
</body>
</html>